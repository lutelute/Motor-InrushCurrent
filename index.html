<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>モーター突入電流シミュレーター</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            min-height: 100vh;
        }
        .container { padding: 1rem; max-width: 1200px; margin: 0 auto; }
        .card { background: #1f2937; padding: 1rem; margin: 1rem 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .flex { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .btn {
            padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;
            background: #374151; color: #d1d5db; transition: all 0.2s;
        }
        .btn-active { background: #2563eb; color: white; }
        .btn:hover { background: #4b5563; }
        .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .input-group label { font-size: 0.75rem; color: #9ca3af; }
        .input-group input, .input-group select {
            padding: 0.25rem 0.5rem; border-radius: 4px; border: none;
            background: #374151; color: white; font-size: 0.875rem;
        }
        .stat-box {
            background: #1f2937; padding: 1rem; border-radius: 6px; text-align: center;
            border: 1px solid #374151;
        }
        .stat-label { font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.125rem; font-weight: bold; }
        .text-blue { color: #60a5fa; }
        .text-green { color: #4ade80; }
        .text-red { color: #f87171; }
        .text-yellow { color: #facc15; }
        .text-purple { color: #c084fc; }
        .chart-container { background: #1f2937; padding: 1rem; border-radius: 8px; height: 400px; }
        h1 { text-align: center; margin: 1rem 0; color: #60a5fa; font-size: 1.5rem; }
        h2 { color: #60a5fa; margin-bottom: 0.5rem; }
        h3 { color: #60a5fa; margin-bottom: 1rem; }
        .motor-info { display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap; }
        .motor-diagram { width: 120px; height: 120px; flex-shrink: 0; }
        .motor-details { flex: 1; min-width: 200px; }
        .feature-list { list-style: none; font-size: 0.8rem; }
        .feature-list li { margin: 0.25rem 0; color: #d1d5db; }
        .feature-list li:before { content: "• "; color: #60a5fa; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #374151; }
        th { color: #9ca3af; font-size: 0.875rem; }
        tr:hover { background: #374151; }
        @media (max-width: 768px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, ReferenceArea } = Recharts;

        // モーター種類定義
        const MOTOR_TYPES = {
            squirrelCage: {
                id: 'squirrelCage',
                name: 'かご型誘導機',
                category: '誘導機',
                description: '最も普及。回転子に導体バー（かご状）を配置。構造がシンプルで堅牢。',
                features: ['構造が単純で安価', '保守が容易', '始動電流が大きい（定格の4〜8倍）', '始動トルクは中程度'],
                applications: 'ポンプ、ファン、コンベア、工作機械など',
                inrushMultiplier: 6,
                startTorque: 1.5,
                hasSlipRings: false,
                rotorType: 'cage',
            },
            woundRotor: {
                id: 'woundRotor',
                name: '巻線型誘導機',
                category: '誘導機',
                description: '回転子に三相巻線を持ち、スリップリングで外部抵抗を接続可能。',
                features: ['外部抵抗で始動電流を制御可能', '始動トルクを大きくできる', '速度制御が可能（効率は低下）', '構造が複雑でコスト高'],
                applications: 'クレーン、ホイスト、大型ポンプ、圧縮機',
                inrushMultiplier: 3,
                startTorque: 2.5,
                hasSlipRings: true,
                rotorType: 'wound',
            },
            salientPole: {
                id: 'salientPole',
                name: '突極型同期機',
                category: '同期機',
                description: '磁極が回転子から突出。低速・多極用途に最適。',
                features: ['極数を多くできる（水車直結向き）', '回転数は電源周波数に同期', '力率調整が可能', 'ダンパ巻線で始動（誘導機として）'],
                applications: '水力発電機、低速大型機械',
                inrushMultiplier: 5,
                startTorque: 0.4,
                hasSlipRings: true,
                rotorType: 'salient',
            },
            cylindrical: {
                id: 'cylindrical',
                name: '円筒型同期機',
                category: '同期機',
                description: '円筒形の回転子に溝を切って界磁巻線を収納。高速回転向き。',
                features: ['高速回転に適した構造（2極/4極）', '機械的強度が高い', '風損が少ない', 'タービン直結に最適'],
                applications: '火力・原子力発電機（タービン発電機）',
                inrushMultiplier: 5,
                startTorque: 0.3,
                hasSlipRings: true,
                rotorType: 'cylindrical',
            },
        };

        // 回転子図
        const RotorDiagram = ({ type }) => {
            return (
                <svg viewBox="0 0 120 120" className="motor-diagram">
                    <circle cx="60" cy="60" r="50" fill="#374151" stroke="#6B7280" strokeWidth="2" />
                    {type === 'cage' && (
                        <>
                            {[...Array(12)].map((_, i) => {
                                const angle = (i * 30 * Math.PI) / 180;
                                const x1 = 60 + 35 * Math.cos(angle);
                                const y1 = 60 + 35 * Math.sin(angle);
                                const x2 = 60 + 47 * Math.cos(angle);
                                const y2 = 60 + 47 * Math.sin(angle);
                                return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke="#F59E0B" strokeWidth="2" />;
                            })}
                            <circle cx="60" cy="60" r="35" fill="none" stroke="#F59E0B" strokeWidth="2" />
                            <circle cx="60" cy="60" r="47" fill="none" stroke="#F59E0B" strokeWidth="2" />
                        </>
                    )}
                    {type === 'wound' && (
                        <>
                            {[0, 120, 240].map((deg, i) => {
                                const colors = ['#EF4444', '#22C55E', '#3B82F6'];
                                const angle = (deg * Math.PI) / 180;
                                return (
                                    <g key={i}>
                                        <path
                                            d={`M${60 + 20 * Math.cos(angle)},${60 + 20 * Math.sin(angle)} 
                                                Q${60 + 35 * Math.cos(angle + 0.3)},${60 + 35 * Math.sin(angle + 0.3)} 
                                                ${60 + 45 * Math.cos(angle)},${60 + 45 * Math.sin(angle)}`}
                                            fill="none" stroke={colors[i]} strokeWidth="2"
                                        />
                                    </g>
                                );
                            })}
                        </>
                    )}
                    <circle cx="60" cy="60" r="10" fill="#4B5563" stroke="#6B7280" strokeWidth="1" />
                    <text x="60" y="110" textAnchor="middle" fill="#9CA3AF" fontSize="8">
                        {type === 'cage' && 'かご型'}
                        {type === 'wound' && '巻線型'}
                        {type === 'salient' && '突極型'}
                        {type === 'cylindrical' && '円筒型'}
                    </text>
                </svg>
            );
        };

        function MotorInrushSimulator() {
            const [selectedMotor, setSelectedMotor] = useState('squirrelCage');
            const [ratedPower, setRatedPower] = useState(7.5);
            const [ratedVoltage, setRatedVoltage] = useState(200);
            const [frequency, setFrequency] = useState(50);
            const [switchingAngle, setSwitchingAngle] = useState(0);
            const [dcTimeConstant, setDcTimeConstant] = useState(50);
            const [viewCycles, setViewCycles] = useState(10);

            const motor = MOTOR_TYPES[selectedMotor];

            // シミュレーションデータ計算
            const simulationData = useMemo(() => {
                const omega = 2 * Math.PI * frequency;
                const period = 1 / frequency;
                const endTime = viewCycles * period;
                const timeStep = period / 100;
                
                const powerFactor = 0.85;
                const ratedCurrent = (ratedPower * 1000) / (Math.sqrt(3) * ratedVoltage * powerFactor);
                const peakRated = ratedCurrent * Math.sqrt(2);
                const peakInrush = peakRated * motor.inrushMultiplier;
                
                const phi0 = (switchingAngle * Math.PI) / 180;
                const tau = dcTimeConstant / 1000;
                const tauAC = motor.category === '同期機' ? 0.5 : 0.3;
                
                const data = [];
                let maxCurrent = 0;

                for (let t = 0; t <= endTime; t += timeStep) {
                    const dcU = peakInrush * Math.sin(phi0) * Math.exp(-t / tau);
                    const acDecay = Math.exp(-t / tauAC);
                    const inrushComponent = (peakInrush - peakRated) * acDecay;
                    const currentAmplitude = peakRated + inrushComponent;
                    
                    const iU = currentAmplitude * Math.sin(omega * t + phi0) + dcU;
                    const iV = currentAmplitude * Math.sin(omega * t + phi0 - 2 * Math.PI / 3);
                    const iW = currentAmplitude * Math.sin(omega * t + phi0 + 2 * Math.PI / 3);
                    
                    maxCurrent = Math.max(maxCurrent, Math.abs(iU), Math.abs(iV), Math.abs(iW));
                    
                    data.push({
                        time: parseFloat((t * 1000).toFixed(1)),
                        iU: parseFloat(iU.toFixed(1)),
                        iV: parseFloat(iV.toFixed(1)),
                        iW: parseFloat(iW.toFixed(1)),
                        dcU: parseFloat(dcU.toFixed(1)),
                    });
                }
                
                return { data, ratedCurrent, peakRated, peakInrush, maxCurrent };
            }, [ratedPower, ratedVoltage, frequency, motor.inrushMultiplier, switchingAngle, dcTimeConstant, viewCycles, motor.category]);

            const getPhaseDescription = (angle) => {
                if (angle === 0 || angle === 180) return 'DC成分最小';
                if (angle === 90 || angle === 270) return 'DC成分最大';
                return '';
            };

            return (
                <div className="container">
                    <h1>モーター始動時 突入電流シミュレーション</h1>
                    
                    {/* モーター種類選択 */}
                    <div className="card">
                        <div className="flex">
                            {Object.values(MOTOR_TYPES).map((m) => (
                                <button
                                    key={m.id}
                                    onClick={() => setSelectedMotor(m.id)}
                                    className={`btn ${selectedMotor === m.id ? 'btn-active' : ''}`}
                                >
                                    {m.name}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* モーター情報 */}
                    <div className="card">
                        <div className="motor-info">
                            <RotorDiagram type={motor.rotorType} />
                            <div className="motor-details">
                                <h2>{motor.name} ({motor.category})</h2>
                                <p style={{marginBottom: '1rem', color: '#d1d5db', fontSize: '0.9rem'}}>{motor.description}</p>
                                <div className="grid grid-2">
                                    <div>
                                        <h3 style={{fontSize: '0.9rem', marginBottom: '0.5rem'}}>特徴</h3>
                                        <ul className="feature-list">
                                            {motor.features.map((f, i) => (
                                                <li key={i}>{f}</li>
                                            ))}
                                        </ul>
                                    </div>
                                    <div>
                                        <h3 style={{fontSize: '0.9rem', marginBottom: '0.5rem'}}>用途</h3>
                                        <p style={{fontSize: '0.8rem', color: '#d1d5db', marginBottom: '1rem'}}>{motor.applications}</p>
                                        <div style={{fontSize: '0.8rem'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', margin: '0.25rem 0'}}>
                                                <span>突入電流倍率:</span>
                                                <span className="text-yellow">{motor.inrushMultiplier}倍</span>
                                            </div>
                                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                <span>始動トルク:</span>
                                                <span className="text-green">{motor.startTorque} p.u.</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* パラメータ設定 */}
                    <div className="card">
                        <h3>パラメータ設定</h3>
                        <div className="grid grid-4">
                            <div className="input-group">
                                <label>定格出力 [kW]</label>
                                <input type="range" min="0.75" max="37" step="0.25" value={ratedPower}
                                    onChange={(e) => setRatedPower(parseFloat(e.target.value))} />
                                <span className="text-blue">{ratedPower} kW</span>
                            </div>
                            <div className="input-group">
                                <label>定格電圧 [V]</label>
                                <select value={ratedVoltage} onChange={(e) => setRatedVoltage(parseInt(e.target.value))}>
                                    <option value={200}>200V</option>
                                    <option value={400}>400V</option>
                                    <option value={6600}>6.6kV</option>
                                </select>
                            </div>
                            <div className="input-group">
                                <label>電源周波数 [Hz]</label>
                                <select value={frequency} onChange={(e) => setFrequency(parseInt(e.target.value))}>
                                    <option value={50}>50Hz</option>
                                    <option value={60}>60Hz</option>
                                </select>
                            </div>
                            <div className="input-group">
                                <label>投入位相角 [°]</label>
                                <input type="range" min="0" max="360" step="15" value={switchingAngle}
                                    onChange={(e) => setSwitchingAngle(parseInt(e.target.value))} />
                                <span className="text-purple">{switchingAngle}° {getPhaseDescription(switchingAngle)}</span>
                            </div>
                            <div className="input-group">
                                <label>DC減衰時定数 [ms]</label>
                                <input type="range" min="10" max="200" step="5" value={dcTimeConstant}
                                    onChange={(e) => setDcTimeConstant(parseInt(e.target.value))} />
                                <span className="text-purple">{dcTimeConstant} ms</span>
                            </div>
                            <div className="input-group">
                                <label>表示サイクル数</label>
                                <input type="range" min="3" max="30" step="1" value={viewCycles}
                                    onChange={(e) => setViewCycles(parseInt(e.target.value))} />
                                <span className="text-green">{viewCycles} サイクル</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* 計算結果 */}
                    <div className="card">
                        <h3>計算結果</h3>
                        <div className="grid grid-4">
                            <div className="stat-box">
                                <div className="stat-label">定格電流</div>
                                <div className="stat-value text-green">{simulationData.ratedCurrent.toFixed(1)} A</div>
                            </div>
                            <div className="stat-box">
                                <div className="stat-label">定格ピーク</div>
                                <div className="stat-value text-green">{simulationData.peakRated.toFixed(1)} A</div>
                            </div>
                            <div className="stat-box">
                                <div className="stat-label">突入ピーク</div>
                                <div className="stat-value text-red">{simulationData.peakInrush.toFixed(1)} A</div>
                            </div>
                            <div className="stat-box">
                                <div className="stat-label">最大電流</div>
                                <div className="stat-value text-red">{simulationData.maxCurrent.toFixed(1)} A</div>
                            </div>
                        </div>
                    </div>

                    {/* 三相電流波形 */}
                    <div className="card">
                        <h3>三相電流波形</h3>
                        <div className="chart-container">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={simulationData.data}>
                                    <CartesianGrid strokeDasharray="3,3" stroke="#374151" />
                                    <XAxis 
                                        dataKey="time" 
                                        tick={{ fill: '#9CA3AF', fontSize: 10 }}
                                        label={{ value: '時間 [ms]', position: 'insideBottom', offset: -5, style: { textAnchor: 'middle', fill: '#9CA3AF' } }}
                                    />
                                    <YAxis 
                                        tick={{ fill: '#9CA3AF', fontSize: 10 }}
                                        label={{ value: '電流 [A]', angle: -90, position: 'insideLeft', style: { textAnchor: 'middle', fill: '#9CA3AF' } }}
                                    />
                                    <Tooltip 
                                        contentStyle={{ backgroundColor: '#374151', border: '1px solid #6B7280', borderRadius: '4px' }}
                                        labelStyle={{ color: '#D1D5DB' }}
                                    />
                                    <Legend />
                                    
                                    <Line dataKey="iU" stroke="#EF4444" strokeWidth={2} dot={false} name="U相電流" />
                                    <Line dataKey="iV" stroke="#22C55E" strokeWidth={2} dot={false} name="V相電流" />
                                    <Line dataKey="iW" stroke="#3B82F6" strokeWidth={2} dot={false} name="W相電流" />
                                    
                                    <ReferenceLine y={0} stroke="#6B7280" strokeDasharray="2,2" />
                                    <ReferenceLine y={simulationData.peakRated} stroke="#22C55E" strokeDasharray="3,3" />
                                    <ReferenceLine y={-simulationData.peakRated} stroke="#22C55E" strokeDasharray="3,3" />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {/* DC成分 */}
                    <div className="card">
                        <h3>DC成分の減衰</h3>
                        <div className="chart-container">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={simulationData.data}>
                                    <CartesianGrid strokeDasharray="3,3" stroke="#374151" />
                                    <XAxis 
                                        dataKey="time" 
                                        tick={{ fill: '#9CA3AF', fontSize: 10 }}
                                        label={{ value: '時間 [ms]', position: 'insideBottom', offset: -5, style: { textAnchor: 'middle', fill: '#9CA3AF' } }}
                                    />
                                    <YAxis 
                                        tick={{ fill: '#9CA3AF', fontSize: 10 }}
                                        label={{ value: 'DC成分 [A]', angle: -90, position: 'insideLeft', style: { textAnchor: 'middle', fill: '#9CA3AF' } }}
                                    />
                                    <Tooltip 
                                        contentStyle={{ backgroundColor: '#374151', border: '1px solid #6B7280', borderRadius: '4px' }}
                                        labelStyle={{ color: '#D1D5DB' }}
                                    />
                                    <Legend />
                                    
                                    <Line dataKey="dcU" stroke="#EC4899" strokeWidth={2} dot={false} name="U相 DC成分" />
                                    <ReferenceLine y={0} stroke="#6B7280" strokeDasharray="2,2" />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {/* モーター比較表 */}
                    <div className="card">
                        <h3>モーター種類比較</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>種類</th>
                                    <th>突入倍率</th>
                                    <th>始動トルク</th>
                                    <th>制御性</th>
                                </tr>
                            </thead>
                            <tbody>
                                {Object.values(MOTOR_TYPES).map((m) => (
                                    <tr key={m.id} onClick={() => setSelectedMotor(m.id)} style={{cursor: 'pointer'}}>
                                        <td>
                                            <div style={{fontWeight: 'bold', color: '#60a5fa'}}>{m.name}</div>
                                            <div style={{fontSize: '0.75rem', color: '#9ca3af'}}>{m.category}</div>
                                        </td>
                                        <td className="text-yellow">{m.inrushMultiplier}×</td>
                                        <td className="text-green">{m.startTorque}</td>
                                        <td>{m.hasSlipRings ? 
                                            <span className="text-green">◎ 良好</span> : 
                                            <span className="text-yellow">△ 限定的</span>}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<MotorInrushSimulator />, document.getElementById('root'));
    </script>
</body>
</html>